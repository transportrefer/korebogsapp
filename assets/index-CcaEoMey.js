(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const S={clientId:"129709058864-dmk39lre4jrop8ch05t1taeggmchhoqs.apps.googleusercontent.com",apiKey:"AIzaSyApeC-_5XObrNatcG_yxUna853dpkyHmlM",scopes:["https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/spreadsheets"],discoveryDocs:["https://sheets.googleapis.com/$discovery/rest?version=v4"]};console.log("Auth configuration:",{clientId:S.clientId,hasApiKey:!0,origin:window.location.origin,pathname:window.location.pathname});let d=null,B=!1,g=null,k,_,z,G,$,N,X,W;async function re(){return console.log("Initializing auth module"),k=document.getElementById("login-btn"),_=document.getElementById("login-main-btn"),z=document.getElementById("logout-btn"),G=document.getElementById("auth-section"),$=document.getElementById("app-section"),N=document.getElementById("user-profile"),X=document.getElementById("user-avatar"),W=document.getElementById("user-name"),k.addEventListener("click",T),_.addEventListener("click",T),z.addEventListener("click",H),await se(),await P(),{isAuthenticated:()=>B,getCurrentUser:()=>g,login:T,logout:H}}function se(){return new Promise((e,t)=>{if(console.log("Loading Google API client"),window.gapi){console.log("Google API client already loaded"),gapi.load("client:auth2",o=>{o?(console.error("Error loading gapi client:auth2:",o),t(o)):(console.log("gapi client:auth2 loaded successfully"),e())});return}const n=document.createElement("script");n.src="https://apis.google.com/js/api.js",n.async=!0,n.defer=!0,n.onload=()=>{console.log("Google API script loaded"),gapi.load("client:auth2",o=>{o?(console.error("Error loading gapi client:auth2:",o),t(o)):(console.log("gapi client:auth2 loaded successfully"),e())})},n.onerror=o=>{console.error("Error loading Google API script:",o),t(o)},document.body.appendChild(n)})}async function P(){try{return await gapi.client.init({apiKey:S.apiKey,clientId:S.clientId,discoveryDocs:S.discoveryDocs,scope:S.scopes.join(" ")}),d=gapi.auth2.getAuthInstance(),B=d.isSignedIn.get(),d.isSignedIn.listen(V),V(B),d}catch(e){throw console.error("Error initializing Google Auth:",e),e}}async function ae(){if(!d)try{await P()}catch(e){return console.error("Error checking auth status:",e),!1}return d.isSignedIn.get()}function V(e){if(e){const n=d.currentUser.get().getBasicProfile();g={id:n.getId(),name:n.getName(),email:n.getEmail(),avatarUrl:n.getImageUrl()},ie()}else g=null,Y()}async function T(){if(console.log("Login clicked"),!d)try{console.log("Initializing Google Auth for login"),await P()}catch(e){console.error("Error initializing Google Auth for login:",e);return}try{localStorage.getItem("auth_code")?(console.log("Auth code found in storage, exchanging for token"),localStorage.removeItem("auth_code"),d.isSignedIn.get()?console.log("User already signed in"):(console.log("User not signed in, starting OAuth flow again"),await J())):(console.log("Starting OAuth flow"),await J())}catch(e){console.error("Error during sign in:",e)}}async function J(){const e=Math.random().toString(36).substring(2,15);console.log("Generated state for OAuth flow:",e),localStorage.setItem("oauth_state",e);try{if(console.log("Starting Google sign-in flow"),window.location.hostname.includes("github.io")){console.log("Detected GitHub Pages environment, using specific redirect URI");const o={redirect_uri:"https://transportrefer.github.io/korebogsapp/callback.html"};await d.signIn(o)}else await d.signIn();console.log("Sign-in flow completed")}catch(t){throw console.error("Error starting OAuth flow:",t),t}}async function H(){if(console.log("Logout clicked"),!!d)try{await d.signOut(),g=null,Y()}catch(e){console.error("Error during sign out:",e)}}function ie(){k.style.display="none",N.style.display="flex",X.src=g.avatarUrl||"https://ui-avatars.com/api/?name="+encodeURIComponent(g.name),W.textContent=g.name,G.style.display="none",$.style.display="block",window.dispatchEvent(new CustomEvent("userAuthenticated",{detail:g}))}function Y(){k.style.display="block",N.style.display="none",G.style.display="flex",$.style.display="none",window.dispatchEvent(new CustomEvent("userSignedOut"))}const le={apiKey:"AIzaSyApeC-_5XObrNatcG_yxUna853dpkyHmlM"};let m=!1,de=null,K=null,M=null;async function ce(){console.log("Initializing maps module");try{return await ue(),console.log("Google Maps API loaded successfully"),window.google&&window.google.maps&&(K=new google.maps.DistanceMatrixService,M=new google.maps.Geocoder,de=new google.maps.places.AutocompleteService,m=!0),{calculateDistance:ge,getUserLocation:pe,autocompleteAddress:me,isLoaded:()=>m}}catch(e){return console.error("Error initializing Google Maps:",e),{calculateDistance:U,getUserLocation:Z,autocompleteAddress:Q,isLoaded:()=>!1}}}function ue(){return new Promise((e,t)=>{if(window.google&&window.google.maps){m=!0,e();return}const n=document.createElement("script");n.src=`https://maps.googleapis.com/maps/api/js?key=${le.apiKey}&libraries=places`,n.async=!0,n.defer=!0,n.onload=()=>{m=!0,e()},n.onerror=o=>{console.error("Google Maps API failed to load:",o),t(o)},document.head.appendChild(n)})}async function ge(e,t){if(console.log(`Calculating distance from "${e}" to "${t}"`),!m||!K)return U(e,t);try{const n=await new Promise((o,s)=>{K.getDistanceMatrix({origins:[e],destinations:[t],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC},(r,i)=>{i==="OK"?o(r):s(new Error(`Distance Matrix request failed with status: ${i}`))})});if(n.rows[0].elements[0].status==="OK"){const o=n.rows[0].elements[0];return{distance:o.distance.value/1e3,duration:Math.round(o.duration.value/60),distanceText:o.distance.text,durationText:o.duration.text,status:"OK"}}else throw new Error(`Route calculation failed with status: ${n.rows[0].elements[0].status}`)}catch(n){return console.error("Error calculating distance:",n),U(e,t)}}async function pe(){console.log("Getting user location");try{const e=await new Promise((s,r)=>{if(!navigator.geolocation){r(new Error("Geolocation is not supported by your browser"));return}navigator.geolocation.getCurrentPosition(s,r,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}),{latitude:t,longitude:n}=e.coords;if(!m||!M)return{coords:{latitude:t,longitude:n},formattedAddress:`${t.toFixed(6)}, ${n.toFixed(6)}`};const o=await new Promise((s,r)=>{M.geocode({location:{lat:t,lng:n}},(i,u)=>{u==="OK"&&i[0]?s(i):r(new Error(`Geocoding failed with status: ${u}`))})});return{coords:{latitude:t,longitude:n},formattedAddress:o[0].formatted_address}}catch(e){return console.error("Error getting user location:",e),Z()}}function me(e,t){if(console.log("Setting up address autocomplete"),!m||!window.google||!window.google.maps)return Q(e,t);const n=new google.maps.places.Autocomplete(e,{types:["address"],componentRestrictions:{country:"dk"}});n.addListener("place_changed",()=>{const o=n.getPlace();o&&o.formatted_address&&t&&t(o.formatted_address)})}function U(e,t){console.log(`Using mock distance calculation from "${e}" to "${t}"`);const n=(Math.random()*90+10).toFixed(1),o=Math.round(n*1.2);return{distance:parseFloat(n),duration:o,distanceText:`${n} km`,durationText:`${o} min`,status:"OK"}}function Z(){return console.log("Using mock user location"),{coords:{latitude:55.676098,longitude:12.568337},formattedAddress:"Rådhuspladsen 1, 1550 København"}}function Q(e,t){console.log("Using mock address autocomplete");const n=["Rådhuspladsen 1, 1550 København","Tivoli, Vesterbrogade 3, 1630 København","Nørreport Station, København","Kongens Nytorv, København","Amagertorv 1, 1160 København","Trianglen, 2100 København Ø","Fisketorvet, Kalvebod Brygge 59, 1560 København"];e.addEventListener("input",()=>{const o=document.getElementById("mock-dropdown");if(o&&o.remove(),e.value.length>0){const s=n.filter(r=>r.toLowerCase().includes(e.value.toLowerCase()));if(s.length>0){const r=document.createElement("div");r.id="mock-dropdown",r.style.position="absolute",r.style.width=`${e.offsetWidth}px`,r.style.maxHeight="200px",r.style.overflowY="auto",r.style.background="white",r.style.border="1px solid #ddd",r.style.borderTop="none",r.style.zIndex="1000",s.forEach(u=>{const c=document.createElement("div");c.textContent=u,c.style.padding="8px 12px",c.style.cursor="pointer",c.addEventListener("mouseover",()=>{c.style.backgroundColor="#f2f2f2"}),c.addEventListener("mouseout",()=>{c.style.backgroundColor="white"}),c.addEventListener("click",()=>{e.value=u,r.remove(),t&&t(u)}),r.appendChild(c)});const i=e.getBoundingClientRect();r.style.top=`${i.bottom}px`,r.style.left=`${i.left}px`,document.body.appendChild(r)}}}),document.addEventListener("click",o=>{if(o.target!==e){const s=document.getElementById("mock-dropdown");s&&s.remove()}})}const f={localStorageKeys:{drivesData:"kørebogsApp_kørselsData",frequentAddresses:"kørebogsApp_oftebesøgteAdresser",settings:"kørebogsApp_indstillinger"},defaultSettings:{standardSats:3.79,standardStartAdresse:"",googleSheetsId:"",visAdvarselVed60DagesReglen:!0}};let L=[],D=[],j=null;const fe=3.79;let l=[];function ye(){try{const e=localStorage.getItem(f.localStorageKeys.drivesData);L=e?JSON.parse(e):[];const t=localStorage.getItem(f.localStorageKeys.frequentAddresses);D=t?JSON.parse(t):[];const n=localStorage.getItem(f.localStorageKeys.settings);j=n?{...f.defaultSettings,...JSON.parse(n)}:{...f.defaultSettings},console.log("Loaded data from localStorage:",{drives:L.length,addresses:D.length})}catch(e){console.error("Error loading data from localStorage:",e),L=[],D=[],j={...f.defaultSettings}}}function he(){return console.log("Initializing storage module (MOCK VERSION)"),ye(),{saveTrip:ve,getTrips:we,deleteTrip:Ie,updateTrip:Ee,getFavoriteAddresses:Se,saveSettings:Ae,getSettings:ee,syncToCloud:be}}async function ve(e){console.log("Saving trip (MOCK VERSION):",e);const t="trip-"+Date.now(),n={...e,id:t,synced:!1,createdAt:new Date().toISOString()};return l.push(n),w(),await new Promise(o=>setTimeout(o,500)),n.synced=!0,w(),n}async function we(e={}){console.log("Getting trips (MOCK VERSION):",e);let t=[...l];if(e.sort&&t.sort((n,o)=>e.sort==="date"?new Date(o.date)-new Date(n.date):0),e.filter&&e.filter.date){const n=new Date(e.filter.date);t=t.filter(o=>new Date(o.date).toDateString()===n.toDateString())}return t}async function Ie(e){console.log("Deleting trip (MOCK VERSION):",e);const t=l.findIndex(n=>n.id===e);return t!==-1?(l.splice(t,1),w(),!0):!1}async function Ee(e,t){console.log("Updating trip (MOCK VERSION):",e,t);const n=l.findIndex(o=>o.id===e);if(n!==-1)return l[n]={...l[n],...t,synced:!1,updatedAt:new Date().toISOString()},w(),await new Promise(o=>setTimeout(o,500)),l[n].synced=!0,w(),l[n];throw new Error("Trip not found")}async function Se(){console.log("Getting favorite addresses (MOCK VERSION)");const e=localStorage.getItem("favoriteAddresses");if(e)return JSON.parse(e);const t=[{id:"addr-1",address:"Rådhuspladsen 1, 1550 København",description:"Københavns Rådhus",lastUsed:new Date().toISOString()},{id:"addr-2",address:"Tivoli, Vesterbrogade 3, 1630 København",description:"Tivoli",lastUsed:"2023-01-15T12:30:00.000Z"}];return localStorage.setItem("favoriteAddresses",JSON.stringify(t)),t}async function Ae(e){console.log("Saving settings (MOCK VERSION):",e);const n={...await ee(),...e};return localStorage.setItem("userSettings",JSON.stringify(n)),n}async function ee(){console.log("Getting settings (MOCK VERSION)");const e=localStorage.getItem("userSettings");if(e)return JSON.parse(e);const t={defaultRate:fe,defaultStartAddress:"",showRoundTripOption:!0,sheetsId:""};return localStorage.setItem("userSettings",JSON.stringify(t)),t}async function be(){console.log("Syncing to cloud (MOCK VERSION)");const e=l.filter(t=>!t.synced);return await new Promise(t=>setTimeout(t,1e3)),e.forEach(t=>{const n=l.findIndex(o=>o.id===t.id);n!==-1&&(l[n].synced=!0)}),w(),{success:!0,syncedCount:e.length,total:l.length}}function w(){try{localStorage.setItem("trips",JSON.stringify(l))}catch(e){console.error("Error saving to localStorage:",e)}}let ke=null,te,I,E,b,C,x,h,p,v,O,ne,oe,A,a={date:"",startAddress:"",endAddress:"",purpose:"",roundTrip:!1,distance:0,amount:0},R={defaultRate:3.79};async function Ce(){const e=document.getElementById("drive-start").value.trim(),t=document.getElementById("drive-end").value.trim(),n=document.getElementById("drive-roundtrip").checked,o=parseFloat(document.getElementById("drive-rate").value);if(!e||!t){q("Manglende adresser","Indtast både start- og slutadresse.");return}const s=document.getElementById("calculate-btn"),r=document.getElementById("save-btn");try{s.disabled=!0,s.textContent="Beregner...";let u=(await ke.calculateDistance(e,t)).distance;n&&(u*=2);const c=u*o;document.getElementById("calculated-distance").textContent=u.toFixed(2),document.getElementById("calculated-amount").textContent=c.toFixed(2),r.disabled=!1}catch(i){q("Beregningsfejl","Kunne ikke beregne distance. Kontroller adresserne og prøv igen."),console.error("Error calculating distance:",i)}finally{s.disabled=!1,s.textContent="Beregn distance"}}function q(e,t){alert(`${e}: ${t}`)}function xe(){console.log("Initializing UI module"),te=document.getElementById("trip-form"),I=document.getElementById("date"),E=document.getElementById("start-address"),b=document.getElementById("end-address"),C=document.getElementById("purpose"),x=document.getElementById("round-trip"),h=document.getElementById("calculate-btn"),p=document.getElementById("save-btn"),v=document.getElementById("use-current-location"),O=document.getElementById("distance-result"),ne=document.getElementById("distance"),oe=document.getElementById("amount"),A=document.getElementById("trips-list"),I.valueAsDate=new Date,Ue(),Oe(),Te(),F()}function Oe(){h.addEventListener("click",Le),te.addEventListener("submit",De),v.addEventListener("click",Be),I.addEventListener("change",y),E.addEventListener("change",y),b.addEventListener("change",y),C.addEventListener("change",y),x.addEventListener("change",y)}function Te(){autocompleteAddress(E,e=>{a.startAddress=e}),autocompleteAddress(b,e=>{a.endAddress=e})}async function Le(){if(y(),!a.startAddress||!a.endAddress){alert("Både start- og slutadresse skal angives");return}try{h.textContent="Beregner...",h.disabled=!0;const e=await Ce(a.startAddress,a.endAddress);a.distance=e.distance,a.amount=Ke(e.distance,R.defaultRate,a.roundTrip),ne.textContent=a.distance.toFixed(1),oe.textContent=a.amount.toFixed(2),O.style.display="block",p.disabled=!1}catch(e){console.error("Error calculating distance:",e),alert("Der opstod en fejl ved beregning af afstand. Prøv igen.")}finally{h.textContent="Beregn",h.disabled=!1}}async function De(e){if(e.preventDefault(),a.distance<=0){alert("Du skal beregne afstanden først");return}try{p.textContent="Gemmer...",p.disabled=!0;const t={date:a.date,startAddress:a.startAddress,endAddress:a.endAddress,purpose:a.purpose,roundTrip:a.roundTrip,distance:a.distance,rate:R.defaultRate,amount:a.amount},n=await saveTrip(t);Me(),F(),alert("Kørslen er gemt")}catch(t){console.error("Error saving trip:",t),alert("Der opstod en fejl ved gemning af kørsel. Prøv igen.")}finally{p.textContent="Gem",p.disabled=!0}}async function Be(){try{v.textContent="...",v.disabled=!0;const e=await getUserLocation();E.value=e.formattedAddress,a.startAddress=e.formattedAddress}catch(e){console.error("Error getting current location:",e),alert("Der opstod en fejl ved hentning af din placering. Prøv igen.")}finally{v.textContent="📍",v.disabled=!1}}function y(){a.date=I.value,a.startAddress=E.value,a.endAddress=b.value,a.purpose=C.value,a.roundTrip=x.checked,a.distance>0&&(a.distance=0,a.amount=0,O.style.display="none",p.disabled=!0)}function Ke(e,t,n){return(n?e*2:e)*t}function Me(){I.valueAsDate=new Date,E.value="",b.value="",C.value="",x.checked=!1,O.style.display="none",a={date:I.value,startAddress:"",endAddress:"",purpose:"",roundTrip:!1,distance:0,amount:0},p.disabled=!0}async function Ue(){try{R=await getSettings()}catch(e){console.error("Error loading settings:",e)}}async function F(){try{const e=await getTrips({sort:"date"});if(A.innerHTML="",e.length===0){const t=document.createElement("p");t.className="placeholder",t.textContent="Ingen kørsler registreret endnu.",A.appendChild(t);return}e.forEach(t=>{const n=Ge(t);A.appendChild(n)})}catch(e){console.error("Error loading trips:",e),A.innerHTML='<p class="placeholder">Kunne ikke indlæse kørsler.</p>'}}function Ge(e){const t=document.createElement("div");t.className="trip-item",t.dataset.id=e.id;const o=new Date(e.date).toLocaleDateString("da-DK");t.innerHTML=`
    <div class="trip-header">
      <strong>${o}</strong>
      <span>${e.purpose}</span>
    </div>
    <div class="trip-details">
      <p>Fra: ${e.startAddress}</p>
      <p>Til: ${e.endAddress}</p>
      <p>
        Afstand: ${e.distance.toFixed(1)} km
        ${e.roundTrip?"(tur/retur)":""}
      </p>
      <p>Beløb: ${e.amount.toFixed(2)} kr.</p>
    </div>
    <div class="trip-actions">
      <button class="edit-trip-btn" data-id="${e.id}">Rediger</button>
      <button class="delete-trip-btn" data-id="${e.id}">Slet</button>
    </div>
    ${e.synced?"":'<div class="sync-status">Ikke synkroniseret</div>'}
  `;const s=t.querySelector(".edit-trip-btn"),r=t.querySelector(".delete-trip-btn");return s.addEventListener("click",()=>$e(e.id)),r.addEventListener("click",()=>Ne(e.id)),t}function $e(e){alert("Redigering af kørsler kommer i fremtidige versioner")}async function Ne(e){if(confirm("Er du sikker på, at du vil slette denne kørsel?"))try{await deleteTrip(e),F()}catch(t){console.error("Error deleting trip:",t),alert("Der opstod en fejl ved sletning af kørslen. Prøv igen.")}}async function Pe(){console.log("Initializing Kørselsregistrering app..."),re().then(()=>ae()).then(e=>{e?(console.log("User is authenticated, initializing app modules"),ce(),he(),xe()):console.log("User is not authenticated, showing login page")}).catch(e=>{console.error("Error initializing application:",e)})}document.addEventListener("DOMContentLoaded",Pe);
