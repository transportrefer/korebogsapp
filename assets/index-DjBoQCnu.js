(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const g of s.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&o(g)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const F={clientId:"129709058864-dmk39lre4jrop8ch05t1taeggmchhoqs.apps.googleusercontent.com",scopes:["https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/spreadsheets","https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email"]},c={ACCESS_TOKEN:"auth_access_token",REFRESH_TOKEN:"auth_refresh_token",TOKEN_EXPIRY:"auth_token_expiry",USER_DATA:"auth_user_data",DEVICE_ID:"auth_device_id"},P="kb_device_recognized",re=30;console.log("Auth configuration:",{clientId:F.clientId,hasApiKey:!0,origin:window.location.origin,pathname:window.location.pathname});let w=!1,a=null,b=null,u,L,_,S,I,m,x,D;async function se(){console.log("Initializing auth module"),u=document.getElementById("login-btn"),L=document.getElementById("login-main-btn"),_=document.getElementById("logout-btn"),S=document.getElementById("auth-section"),I=document.getElementById("app-section"),m=document.getElementById("user-profile"),x=document.getElementById("user-avatar"),D=document.getElementById("user-name"),u==null||u.addEventListener("click",U),L==null||L.addEventListener("click",U),_==null||_.addEventListener("click",H),await ie();const e=de(),t=await W();return console.log("Initial auth status check:",t?"Authenticated":"Not authenticated"),t&&a?(G(),e||Z(),window.dispatchEvent(new CustomEvent("userAuthenticated",{detail:a}))):(z(),e&&!t&&ge()),{isAuthenticated:()=>w,getCurrentUser:()=>a,login:U,logout:H}}function ie(){return new Promise((e,t)=>{if(console.log("Loading Google Identity Services"),window.google&&window.google.accounts){console.log("Google Identity Services already loaded"),j(),e();return}const n=document.createElement("script");n.src="https://accounts.google.com/gsi/client",n.async=!0,n.defer=!0,n.onload=()=>{console.log("Google Identity Services script loaded"),j(),e()},n.onerror=o=>{console.error("Error loading Google Identity Services script:",o),t(o)},document.body.appendChild(n)})}function j(){console.log("Initializing Google Identity Services"),b=google.accounts.oauth2.initTokenClient({client_id:F.clientId,scope:F.scopes.join(" "),prompt:"consent",ux_mode:"popup",callback:e=>{if(e.error!==void 0){console.error("Token error:",e);return}if(console.log("Token received successfully:",e),e.access_token){const t=Date.now()+e.expires_in*1e3;localStorage.setItem(c.ACCESS_TOKEN,e.access_token),e.refresh_token&&localStorage.setItem(c.REFRESH_TOKEN,e.refresh_token),localStorage.setItem(c.TOKEN_EXPIRY,t.toString())}ae(e.access_token).then(t=>{console.log("User profile fetched:",t),a=t,w=!0,localStorage.setItem(c.USER_DATA,JSON.stringify(t)),Z(),G(),console.log("UI updated for authenticated user"),window.dispatchEvent(new CustomEvent("userAuthenticated",{detail:a}))}).catch(t=>{console.error("Error fetching user profile:",t)})}})}async function ae(e){console.log("Fetching user profile with access token:",e.substring(0,10)+"...");try{const t=await fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok){console.error("Failed to fetch user profile:",t.status,t.statusText);const o=await t.text();throw console.error("Error details:",o),new Error(`Failed to fetch user profile: ${t.status}`)}const n=await t.json();return console.log("User profile data received:",n),n}catch(t){throw console.error("Exception when fetching user profile:",t),t}}async function U(){if(console.log("Login clicked"),!b){console.error("Token client not initialized");return}b.requestAccessToken({prompt:"consent"})}async function H(){console.log("Logout clicked");const e=localStorage.getItem(c.ACCESS_TOKEN);w=!1,a=null,z();let t=!1;if(google&&google.accounts)try{if(e){console.log("Attempting to revoke access token");try{const o=await fetch(`https://oauth2.googleapis.com/revoke?token=${e}`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"}});o.ok?(console.log("Access token successfully revoked"),t=!0):console.warn("Failed to revoke access token:",o.status)}catch(n){console.error("Error revoking access token:",n)}}}catch(n){console.error("Error during logout process:",n)}M(),le(),window.dispatchEvent(new CustomEvent("userSignedOut")),console.log("Logout complete, revocation "+(t?"successful":"may not have completed"))}function G(){console.log("Updating UI for authenticated user"),console.log("loginBtn:",u),console.log("userProfile:",m),console.log("authSection:",S),console.log("appSection:",I),a&&localStorage.setItem(c.USER_DATA,JSON.stringify(a)),u&&(u.style.display="none"),m&&(m.style.display="flex"),x&&a&&a.picture&&(x.src=a.picture||"https://ui-avatars.com/api/?name="+encodeURIComponent(a.name||"User")),D&&a&&(D.textContent=a.name||"User"),S&&(S.style.display="none"),I&&(I.style.display="block"),window.dispatchEvent(new CustomEvent("userAuthenticated",{detail:a}))}function z(){console.log("Updating UI for unauthenticated user"),u&&(u.style.display="block"),m&&(m.style.display="none"),S&&(S.style.display="flex"),I&&(I.style.display="none"),x&&(x.src=""),D&&(D.textContent=""),window.dispatchEvent(new CustomEvent("userSignedOut"))}async function W(){if(w&&a)return!0;const e=localStorage.getItem(c.ACCESS_TOKEN);localStorage.getItem(c.REFRESH_TOKEN);const t=localStorage.getItem(c.TOKEN_EXPIRY),n=localStorage.getItem(c.USER_DATA);if(!e||!n)return console.log("No stored tokens or user data found"),!1;try{a=JSON.parse(n)}catch(o){return console.error("Error parsing stored user data:",o),M(),!1}return t&&parseInt(t,10)<Date.now()?(console.log("Token has expired"),M(),z(),ce(),!1):(console.log("Valid token found, restoring session"),w=!0,m&&u&&G(),!0)}function ce(){Q("Din session er udløbet. Log venligst ind igen.","error")}function M(){w=!1,a=null,localStorage.removeItem(c.ACCESS_TOKEN),localStorage.removeItem(c.REFRESH_TOKEN),localStorage.removeItem(c.TOKEN_EXPIRY),localStorage.removeItem(c.USER_DATA),a!=null&&a.email&&localStorage.setItem("last_email",a.email)}function Z(){const e=ue();localStorage.setItem(c.DEVICE_ID,e);const t=new Date;t.setDate(t.getDate()+re);const n=window.location.protocol==="https:"?"; secure":"";document.cookie=`${P}=${e}; expires=${t.toUTCString()}; path=/${n}; SameSite=Lax`,console.log("Device cookie set, expires:",t.toUTCString())}function de(){const t=document.cookie.split(";").find(n=>n.trim().startsWith(`${P}=`));return t?(t.split("=")[1],console.log("Device recognized from cookie"),!0):!1}function le(){document.cookie=`${P}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`,localStorage.removeItem(c.DEVICE_ID),console.log("Device cookie cleared")}function ue(){return"device_"+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}function ge(){if(!b){console.error("Token client not initialized");return}console.log("Attempting silent sign-in for recognized device"),Q("Gendanner din session...","info"),b.requestAccessToken({prompt:"none",hint:localStorage.getItem("last_email")||""})}function Q(e,t="error"){let n=document.getElementById("auth-message-container");n||(n=document.createElement("div"),n.id="auth-message-container",document.body.appendChild(n));let o,r;switch(t){case"error":o="#f8d7da",r="#721c24";break;case"info":o="#d1ecf1",r="#0c5460";break;case"success":o="#d4edda",r="#155724";break;default:o="#f8d7da",r="#721c24"}n.style.cssText=`position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
    background-color: ${o}; color: ${r}; padding: 10px 20px; 
    border-radius: 5px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);`,n.textContent=e,setTimeout(()=>{n&&n.parentNode&&n.parentNode.removeChild(n)},5e3)}async function pe(){return console.log("Initializing maps module"),console.warn("Google Maps API key is missing. Using fallback functionality."),fe(!0)}function fe(e=!1){return e&&setTimeout(()=>{const t=document.createElement("div");t.className="warning-notification",t.style.backgroundColor="#fcf8e3",t.style.padding="10px",t.style.borderRadius="4px",t.style.marginBottom="15px",t.style.color="#8a6d3b",t.style.borderLeft="4px solid #f0ad4e",t.innerHTML=`
        <p><strong>Note:</strong> Google Maps is running in limited mode.</p>
        <p>Distance calculations and address autocompletion will use estimates.</p>
      `;const n=document.getElementById("trip-form");n&&n.prepend(t)},1e3),{calculateDistance:me,getUserLocation:he,autocompleteAddress:ve,isLoaded:()=>!1}}function me(e,t){console.log(`Using mock distance calculation from "${e}" to "${t}"`);const n=(Math.random()*90+10).toFixed(1),o=Math.round(n*1.2);return{distance:parseFloat(n),duration:o,distanceText:`${n} km`,durationText:`${o} min`,status:"OK"}}function he(){return console.log("Using mock user location"),{coords:{latitude:55.676098,longitude:12.568337},formattedAddress:"Rådhuspladsen 1, 1550 København"}}function ve(e,t){console.log("Using mock address autocomplete");const n=["Rådhuspladsen 1, 1550 København","Tivoli, Vesterbrogade 3, 1630 København","Nørreport Station, København","Kongens Nytorv, København","Amagertorv 1, 1160 København","Trianglen, 2100 København Ø","Fisketorvet, Kalvebod Brygge 59, 1560 København"];e.addEventListener("input",()=>{const o=document.getElementById("mock-dropdown");if(o&&o.remove(),e.value.length>0){const r=n.filter(s=>s.toLowerCase().includes(e.value.toLowerCase()));if(r.length>0){const s=document.createElement("div");s.id="mock-dropdown",s.style.position="absolute",s.style.width=`${e.offsetWidth}px`,s.style.maxHeight="200px",s.style.overflowY="auto",s.style.background="white",s.style.border="1px solid #ddd",s.style.borderTop="none",s.style.zIndex="1000",r.forEach(f=>{const l=document.createElement("div");l.textContent=f,l.style.padding="8px 12px",l.style.cursor="pointer",l.addEventListener("mouseover",()=>{l.style.backgroundColor="#f2f2f2"}),l.addEventListener("mouseout",()=>{l.style.backgroundColor="white"}),l.addEventListener("click",()=>{e.value=f,s.remove(),t&&t(f)}),s.appendChild(l)});const g=e.getBoundingClientRect();s.style.top=`${g.bottom}px`,s.style.left=`${g.left}px`,document.body.appendChild(s)}}}),document.addEventListener("click",o=>{if(o.target!==e){const r=document.getElementById("mock-dropdown");r&&r.remove()}})}const h={localStorageKeys:{drivesData:"kørebogsApp_kørselsData",frequentAddresses:"kørebogsApp_oftebesøgteAdresser",settings:"kørebogsApp_indstillinger"},defaultSettings:{standardSats:3.79,standardStartAdresse:"",googleSheetsId:"",visAdvarselVed60DagesReglen:!0}};let R=[],$=[],q=null;const ye=3.79;let d=[];function Ee(){try{const e=localStorage.getItem(h.localStorageKeys.drivesData);R=e?JSON.parse(e):[];const t=localStorage.getItem(h.localStorageKeys.frequentAddresses);$=t?JSON.parse(t):[];const n=localStorage.getItem(h.localStorageKeys.settings);q=n?{...h.defaultSettings,...JSON.parse(n)}:{...h.defaultSettings},console.log("Loaded data from localStorage:",{drives:R.length,addresses:$.length})}catch(e){console.error("Error loading data from localStorage:",e),R=[],$=[],q={...h.defaultSettings}}}function Se(){return console.log("Initializing storage module (MOCK VERSION)"),Ee(),{saveTrip:Ie,getTrips:we,deleteTrip:ke,updateTrip:Ae,getFavoriteAddresses:Te,saveSettings:Ce,getSettings:ee,syncToCloud:be}}async function Ie(e){console.log("Saving trip (MOCK VERSION):",e);const t="trip-"+Date.now(),n={...e,id:t,synced:!1,createdAt:new Date().toISOString()};return d.push(n),k(),await new Promise(o=>setTimeout(o,500)),n.synced=!0,k(),n}async function we(e={}){console.log("Getting trips (MOCK VERSION):",e);let t=[...d];if(e.sort&&t.sort((n,o)=>e.sort==="date"?new Date(o.date)-new Date(n.date):0),e.filter&&e.filter.date){const n=new Date(e.filter.date);t=t.filter(o=>new Date(o.date).toDateString()===n.toDateString())}return t}async function ke(e){console.log("Deleting trip (MOCK VERSION):",e);const t=d.findIndex(n=>n.id===e);return t!==-1?(d.splice(t,1),k(),!0):!1}async function Ae(e,t){console.log("Updating trip (MOCK VERSION):",e,t);const n=d.findIndex(o=>o.id===e);if(n!==-1)return d[n]={...d[n],...t,synced:!1,updatedAt:new Date().toISOString()},k(),await new Promise(o=>setTimeout(o,500)),d[n].synced=!0,k(),d[n];throw new Error("Trip not found")}async function Te(){console.log("Getting favorite addresses (MOCK VERSION)");const e=localStorage.getItem("favoriteAddresses");if(e)return JSON.parse(e);const t=[{id:"addr-1",address:"Rådhuspladsen 1, 1550 København",description:"Københavns Rådhus",lastUsed:new Date().toISOString()},{id:"addr-2",address:"Tivoli, Vesterbrogade 3, 1630 København",description:"Tivoli",lastUsed:"2023-01-15T12:30:00.000Z"}];return localStorage.setItem("favoriteAddresses",JSON.stringify(t)),t}async function Ce(e){console.log("Saving settings (MOCK VERSION):",e);const n={...await ee(),...e};return localStorage.setItem("userSettings",JSON.stringify(n)),n}async function ee(){console.log("Getting settings (MOCK VERSION)");const e=localStorage.getItem("userSettings");if(e)return JSON.parse(e);const t={defaultRate:ye,defaultStartAddress:"",showRoundTripOption:!0,sheetsId:""};return localStorage.setItem("userSettings",JSON.stringify(t)),t}async function be(){console.log("Syncing to cloud (MOCK VERSION)");const e=d.filter(t=>!t.synced);return await new Promise(t=>setTimeout(t,1e3)),e.forEach(t=>{const n=d.findIndex(o=>o.id===t.id);n!==-1&&(d[n].synced=!0)}),k(),{success:!0,syncedCount:e.length,total:d.length}}function k(){try{localStorage.setItem("trips",JSON.stringify(d))}catch(e){console.error("Error saving to localStorage:",e)}}let xe=null,te,A,T,O,K,N,y,p,E,B,ne,oe,C,i={date:"",startAddress:"",endAddress:"",purpose:"",roundTrip:!1,distance:0,amount:0},V={defaultRate:3.79};async function De(){const e=document.getElementById("drive-start").value.trim(),t=document.getElementById("drive-end").value.trim(),n=document.getElementById("drive-roundtrip").checked,o=parseFloat(document.getElementById("drive-rate").value);if(!e||!t){Y("Manglende adresser","Indtast både start- og slutadresse.");return}const r=document.getElementById("calculate-btn"),s=document.getElementById("save-btn");try{r.disabled=!0,r.textContent="Beregner...";let f=(await xe.calculateDistance(e,t)).distance;n&&(f*=2);const l=f*o;document.getElementById("calculated-distance").textContent=f.toFixed(2),document.getElementById("calculated-amount").textContent=l.toFixed(2),s.disabled=!1}catch(g){Y("Beregningsfejl","Kunne ikke beregne distance. Kontroller adresserne og prøv igen."),console.error("Error calculating distance:",g)}finally{r.disabled=!1,r.textContent="Beregn distance"}}function Y(e,t){alert(`${e}: ${t}`)}function Oe(){console.log("Initializing UI module"),te=document.getElementById("trip-form"),A=document.getElementById("date"),T=document.getElementById("start-address"),O=document.getElementById("end-address"),K=document.getElementById("purpose"),N=document.getElementById("round-trip"),y=document.getElementById("calculate-btn"),p=document.getElementById("save-btn"),E=document.getElementById("use-current-location"),B=document.getElementById("distance-result"),ne=document.getElementById("distance"),oe=document.getElementById("amount"),C=document.getElementById("trips-list"),A.valueAsDate=new Date,$e(),Le(),_e(),J()}function Le(){y.addEventListener("click",Ke),te.addEventListener("submit",Ne),E.addEventListener("click",Be),A.addEventListener("change",v),T.addEventListener("change",v),O.addEventListener("change",v),K.addEventListener("change",v),N.addEventListener("change",v)}function _e(){autocompleteAddress(T,e=>{i.startAddress=e}),autocompleteAddress(O,e=>{i.endAddress=e})}async function Ke(){if(v(),!i.startAddress||!i.endAddress){alert("Både start- og slutadresse skal angives");return}try{y.textContent="Beregner...",y.disabled=!0;const e=await De(i.startAddress,i.endAddress);i.distance=e.distance,i.amount=Ue(e.distance,V.defaultRate,i.roundTrip),ne.textContent=i.distance.toFixed(1),oe.textContent=i.amount.toFixed(2),B.style.display="block",p.disabled=!1}catch(e){console.error("Error calculating distance:",e),alert("Der opstod en fejl ved beregning af afstand. Prøv igen.")}finally{y.textContent="Beregn",y.disabled=!1}}async function Ne(e){if(e.preventDefault(),i.distance<=0){alert("Du skal beregne afstanden først");return}try{p.textContent="Gemmer...",p.disabled=!0;const t={date:i.date,startAddress:i.startAddress,endAddress:i.endAddress,purpose:i.purpose,roundTrip:i.roundTrip,distance:i.distance,rate:V.defaultRate,amount:i.amount},n=await saveTrip(t);Re(),J(),alert("Kørslen er gemt")}catch(t){console.error("Error saving trip:",t),alert("Der opstod en fejl ved gemning af kørsel. Prøv igen.")}finally{p.textContent="Gem",p.disabled=!0}}async function Be(){try{E.textContent="...",E.disabled=!0;const e=await getUserLocation();T.value=e.formattedAddress,i.startAddress=e.formattedAddress}catch(e){console.error("Error getting current location:",e),alert("Der opstod en fejl ved hentning af din placering. Prøv igen.")}finally{E.textContent="📍",E.disabled=!1}}function v(){i.date=A.value,i.startAddress=T.value,i.endAddress=O.value,i.purpose=K.value,i.roundTrip=N.checked,i.distance>0&&(i.distance=0,i.amount=0,B.style.display="none",p.disabled=!0)}function Ue(e,t,n){return(n?e*2:e)*t}function Re(){A.valueAsDate=new Date,T.value="",O.value="",K.value="",N.checked=!1,B.style.display="none",i={date:A.value,startAddress:"",endAddress:"",purpose:"",roundTrip:!1,distance:0,amount:0},p.disabled=!0}async function $e(){try{V=await getSettings()}catch(e){console.error("Error loading settings:",e)}}async function J(){try{const e=await getTrips({sort:"date"});if(C.innerHTML="",e.length===0){const t=document.createElement("p");t.className="placeholder",t.textContent="Ingen kørsler registreret endnu.",C.appendChild(t);return}e.forEach(t=>{const n=Fe(t);C.appendChild(n)})}catch(e){console.error("Error loading trips:",e),C.innerHTML='<p class="placeholder">Kunne ikke indlæse kørsler.</p>'}}function Fe(e){const t=document.createElement("div");t.className="trip-item",t.dataset.id=e.id;const o=new Date(e.date).toLocaleDateString("da-DK");t.innerHTML=`
    <div class="trip-header">
      <strong>${o}</strong>
      <span>${e.purpose}</span>
    </div>
    <div class="trip-details">
      <p>Fra: ${e.startAddress}</p>
      <p>Til: ${e.endAddress}</p>
      <p>
        Afstand: ${e.distance.toFixed(1)} km
        ${e.roundTrip?"(tur/retur)":""}
      </p>
      <p>Beløb: ${e.amount.toFixed(2)} kr.</p>
    </div>
    <div class="trip-actions">
      <button class="edit-trip-btn" data-id="${e.id}">Rediger</button>
      <button class="delete-trip-btn" data-id="${e.id}">Slet</button>
    </div>
    ${e.synced?"":'<div class="sync-status">Ikke synkroniseret</div>'}
  `;const r=t.querySelector(".edit-trip-btn"),s=t.querySelector(".delete-trip-btn");return r.addEventListener("click",()=>Me(e.id)),s.addEventListener("click",()=>Pe(e.id)),t}function Me(e){alert("Redigering af kørsler kommer i fremtidige versioner")}async function Pe(e){if(confirm("Er du sikker på, at du vil slette denne kørsel?"))try{await deleteTrip(e),J()}catch(t){console.error("Error deleting trip:",t),alert("Der opstod en fejl ved sletning af kørslen. Prøv igen.")}}async function Ge(){console.log("Initializing Kørselsregistrering app...");try{const e=await se();console.log("Auth initialized, checking status");const t=await W();console.log("Auth status checked, user is authenticated:",t),window.addEventListener("userAuthenticated",n=>{console.log("Authentication event received, user authenticated:",n.detail),X()}),window.addEventListener("userSignedOut",()=>{console.log("User signed out event received")}),t&&X()}catch(e){console.error("Error initializing application:",e)}}function X(){console.log("Initializing rest of app components"),pe(),Se(),Oe()}document.addEventListener("DOMContentLoaded",Ge);
