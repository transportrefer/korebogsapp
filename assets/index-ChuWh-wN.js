(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const $={clientId:"129709058864-dmk39lre4jrop8ch05t1taeggmchhoqs.apps.googleusercontent.com",scopes:["https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/spreadsheets"]};console.log("Auth configuration:",{clientId:$.clientId,hasApiKey:!0,origin:window.location.origin,pathname:window.location.pathname});let w=!1,l=null,M=null,v,z,V,k,b,C,U,N;async function se(){console.log("Initializing auth module"),v=document.getElementById("login-btn"),z=document.getElementById("login-main-btn"),V=document.getElementById("logout-btn"),k=document.getElementById("auth-section"),b=document.getElementById("app-section"),C=document.getElementById("user-profile"),U=document.getElementById("user-avatar"),N=document.getElementById("user-name"),v.addEventListener("click",B),z.addEventListener("click",B),V.addEventListener("click",j),await ae();const e=localStorage.getItem("auth_code");if(e){console.log("Auth code found in storage"),localStorage.removeItem("auth_code");try{await ie(e)}catch(t){console.error("Error handling callback:",t)}}return{isAuthenticated:()=>w,getCurrentUser:()=>l,login:B,logout:j}}function ae(){return new Promise((e,t)=>{if(console.log("Loading Google Identity Services"),window.google&&window.google.accounts){console.log("Google Identity Services already loaded"),J(),e();return}const n=document.createElement("script");n.src="https://accounts.google.com/gsi/client",n.async=!0,n.defer=!0,n.onload=()=>{console.log("Google Identity Services script loaded"),J(),e()},n.onerror=o=>{console.error("Error loading Google Identity Services script:",o),t(o)},document.body.appendChild(n)})}function J(){console.log("Initializing Google Identity Services"),M=google.accounts.oauth2.initTokenClient({client_id:$.clientId,scope:$.scopes.join(" "),callback:e=>{if(e.error!==void 0){console.error("Token error:",e);return}console.log("Token received successfully:",e),Y(e.access_token).then(t=>{console.log("User profile fetched:",t),l=t,w=!0,Z(),console.log("UI updated for authenticated user"),window.dispatchEvent(new CustomEvent("userAuthenticated",{detail:l}))}).catch(t=>{console.error("Error fetching user profile:",t)})}})}async function Y(e){const t=await fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error(`Failed to fetch user profile: ${t.status}`);return await t.json()}async function B(){if(console.log("Login clicked"),!M){console.error("Token client not initialized");return}M.requestAccessToken({prompt:"consent"})}async function ie(e){console.log("Handling OAuth callback with code");try{const t=await de(e);t.access_token&&(l=await Y(t.access_token),w=!0,Z())}catch(t){throw console.error("Error handling callback:",t),t}}async function de(e){return console.log("Simulating code exchange for token"),{access_token:"simulated_access_token",expires_in:3600,token_type:"Bearer"}}async function j(){var e,t;console.log("Logout clicked"),(e=google==null?void 0:google.accounts)!=null&&e.oauth2?google.accounts.oauth2.revoke(((t=google.accounts.oauth2.getAccessToken())==null?void 0:t.access_token)||"",()=>{console.log("Token revoked"),w=!1,l=null,q()}):(w=!1,l=null,q())}function Z(){console.log("Updating UI for authenticated user"),console.log("loginBtn:",v),console.log("userProfile:",C),console.log("authSection:",k),console.log("appSection:",b),v&&(v.style.display="none"),C&&(C.style.display="flex"),U&&l&&l.picture&&(U.src=l.picture||"https://ui-avatars.com/api/?name="+encodeURIComponent(l.name||"User")),N&&l&&(N.textContent=l.name||"User"),k&&(k.style.display="none"),b&&(b.style.display="block"),window.dispatchEvent(new CustomEvent("userAuthenticated",{detail:l}))}function q(){v.style.display="block",C.style.display="none",k.style.display="flex",b.style.display="none",window.dispatchEvent(new CustomEvent("userSignedOut"))}async function le(){return w}const ce={apiKey:"AIzaSyApeC-_5XObrNatcG_yxUna853dpkyHmlM"};let p=!1,ue=null,R=null,F=null;async function ge(){console.log("Initializing maps module");try{return await pe(),console.log("Google Maps API loaded successfully"),window.google&&window.google.maps&&(R=new google.maps.DistanceMatrixService,F=new google.maps.Geocoder,ue=new google.maps.places.AutocompleteService,p=!0),{calculateDistance:me,getUserLocation:fe,autocompleteAddress:ye,isLoaded:()=>p}}catch(e){return console.error("Error initializing Google Maps:",e),{calculateDistance:G,getUserLocation:Q,autocompleteAddress:ee,isLoaded:()=>!1}}}function pe(){return new Promise((e,t)=>{if(window.google&&window.google.maps){p=!0,e();return}const n=document.createElement("script");n.src=`https://maps.googleapis.com/maps/api/js?key=${ce.apiKey}&libraries=places`,n.async=!0,n.defer=!0,n.onload=()=>{p=!0,e()},n.onerror=o=>{console.error("Google Maps API failed to load:",o),t(o)},document.head.appendChild(n)})}async function me(e,t){if(console.log(`Calculating distance from "${e}" to "${t}"`),!p||!R)return G(e,t);try{const n=await new Promise((o,s)=>{R.getDistanceMatrix({origins:[e],destinations:[t],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC},(r,i)=>{i==="OK"?o(r):s(new Error(`Distance Matrix request failed with status: ${i}`))})});if(n.rows[0].elements[0].status==="OK"){const o=n.rows[0].elements[0];return{distance:o.distance.value/1e3,duration:Math.round(o.duration.value/60),distanceText:o.distance.text,durationText:o.duration.text,status:"OK"}}else throw new Error(`Route calculation failed with status: ${n.rows[0].elements[0].status}`)}catch(n){return console.error("Error calculating distance:",n),G(e,t)}}async function fe(){console.log("Getting user location");try{const e=await new Promise((s,r)=>{if(!navigator.geolocation){r(new Error("Geolocation is not supported by your browser"));return}navigator.geolocation.getCurrentPosition(s,r,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}),{latitude:t,longitude:n}=e.coords;if(!p||!F)return{coords:{latitude:t,longitude:n},formattedAddress:`${t.toFixed(6)}, ${n.toFixed(6)}`};const o=await new Promise((s,r)=>{F.geocode({location:{lat:t,lng:n}},(i,u)=>{u==="OK"&&i[0]?s(i):r(new Error(`Geocoding failed with status: ${u}`))})});return{coords:{latitude:t,longitude:n},formattedAddress:o[0].formatted_address}}catch(e){return console.error("Error getting user location:",e),Q()}}function ye(e,t){if(console.log("Setting up address autocomplete"),!p||!window.google||!window.google.maps)return ee(e,t);const n=new google.maps.places.Autocomplete(e,{types:["address"],componentRestrictions:{country:"dk"}});n.addListener("place_changed",()=>{const o=n.getPlace();o&&o.formatted_address&&t&&t(o.formatted_address)})}function G(e,t){console.log(`Using mock distance calculation from "${e}" to "${t}"`);const n=(Math.random()*90+10).toFixed(1),o=Math.round(n*1.2);return{distance:parseFloat(n),duration:o,distanceText:`${n} km`,durationText:`${o} min`,status:"OK"}}function Q(){return console.log("Using mock user location"),{coords:{latitude:55.676098,longitude:12.568337},formattedAddress:"Rådhuspladsen 1, 1550 København"}}function ee(e,t){console.log("Using mock address autocomplete");const n=["Rådhuspladsen 1, 1550 København","Tivoli, Vesterbrogade 3, 1630 København","Nørreport Station, København","Kongens Nytorv, København","Amagertorv 1, 1160 København","Trianglen, 2100 København Ø","Fisketorvet, Kalvebod Brygge 59, 1560 København"];e.addEventListener("input",()=>{const o=document.getElementById("mock-dropdown");if(o&&o.remove(),e.value.length>0){const s=n.filter(r=>r.toLowerCase().includes(e.value.toLowerCase()));if(s.length>0){const r=document.createElement("div");r.id="mock-dropdown",r.style.position="absolute",r.style.width=`${e.offsetWidth}px`,r.style.maxHeight="200px",r.style.overflowY="auto",r.style.background="white",r.style.border="1px solid #ddd",r.style.borderTop="none",r.style.zIndex="1000",s.forEach(u=>{const c=document.createElement("div");c.textContent=u,c.style.padding="8px 12px",c.style.cursor="pointer",c.addEventListener("mouseover",()=>{c.style.backgroundColor="#f2f2f2"}),c.addEventListener("mouseout",()=>{c.style.backgroundColor="white"}),c.addEventListener("click",()=>{e.value=u,r.remove(),t&&t(u)}),r.appendChild(c)});const i=e.getBoundingClientRect();r.style.top=`${i.bottom}px`,r.style.left=`${i.left}px`,document.body.appendChild(r)}}}),document.addEventListener("click",o=>{if(o.target!==e){const s=document.getElementById("mock-dropdown");s&&s.remove()}})}const m={localStorageKeys:{drivesData:"kørebogsApp_kørselsData",frequentAddresses:"kørebogsApp_oftebesøgteAdresser",settings:"kørebogsApp_indstillinger"},defaultSettings:{standardSats:3.79,standardStartAdresse:"",googleSheetsId:"",visAdvarselVed60DagesReglen:!0}};let D=[],K=[],H=null;const he=3.79;let d=[];function ve(){try{const e=localStorage.getItem(m.localStorageKeys.drivesData);D=e?JSON.parse(e):[];const t=localStorage.getItem(m.localStorageKeys.frequentAddresses);K=t?JSON.parse(t):[];const n=localStorage.getItem(m.localStorageKeys.settings);H=n?{...m.defaultSettings,...JSON.parse(n)}:{...m.defaultSettings},console.log("Loaded data from localStorage:",{drives:D.length,addresses:K.length})}catch(e){console.error("Error loading data from localStorage:",e),D=[],K=[],H={...m.defaultSettings}}}function we(){return console.log("Initializing storage module (MOCK VERSION)"),ve(),{saveTrip:Ie,getTrips:Ee,deleteTrip:Se,updateTrip:Ae,getFavoriteAddresses:ke,saveSettings:be,getSettings:te,syncToCloud:Ce}}async function Ie(e){console.log("Saving trip (MOCK VERSION):",e);const t="trip-"+Date.now(),n={...e,id:t,synced:!1,createdAt:new Date().toISOString()};return d.push(n),I(),await new Promise(o=>setTimeout(o,500)),n.synced=!0,I(),n}async function Ee(e={}){console.log("Getting trips (MOCK VERSION):",e);let t=[...d];if(e.sort&&t.sort((n,o)=>e.sort==="date"?new Date(o.date)-new Date(n.date):0),e.filter&&e.filter.date){const n=new Date(e.filter.date);t=t.filter(o=>new Date(o.date).toDateString()===n.toDateString())}return t}async function Se(e){console.log("Deleting trip (MOCK VERSION):",e);const t=d.findIndex(n=>n.id===e);return t!==-1?(d.splice(t,1),I(),!0):!1}async function Ae(e,t){console.log("Updating trip (MOCK VERSION):",e,t);const n=d.findIndex(o=>o.id===e);if(n!==-1)return d[n]={...d[n],...t,synced:!1,updatedAt:new Date().toISOString()},I(),await new Promise(o=>setTimeout(o,500)),d[n].synced=!0,I(),d[n];throw new Error("Trip not found")}async function ke(){console.log("Getting favorite addresses (MOCK VERSION)");const e=localStorage.getItem("favoriteAddresses");if(e)return JSON.parse(e);const t=[{id:"addr-1",address:"Rådhuspladsen 1, 1550 København",description:"Københavns Rådhus",lastUsed:new Date().toISOString()},{id:"addr-2",address:"Tivoli, Vesterbrogade 3, 1630 København",description:"Tivoli",lastUsed:"2023-01-15T12:30:00.000Z"}];return localStorage.setItem("favoriteAddresses",JSON.stringify(t)),t}async function be(e){console.log("Saving settings (MOCK VERSION):",e);const n={...await te(),...e};return localStorage.setItem("userSettings",JSON.stringify(n)),n}async function te(){console.log("Getting settings (MOCK VERSION)");const e=localStorage.getItem("userSettings");if(e)return JSON.parse(e);const t={defaultRate:he,defaultStartAddress:"",showRoundTripOption:!0,sheetsId:""};return localStorage.setItem("userSettings",JSON.stringify(t)),t}async function Ce(){console.log("Syncing to cloud (MOCK VERSION)");const e=d.filter(t=>!t.synced);return await new Promise(t=>setTimeout(t,1e3)),e.forEach(t=>{const n=d.findIndex(o=>o.id===t.id);n!==-1&&(d[n].synced=!0)}),I(),{success:!0,syncedCount:e.length,total:d.length}}function I(){try{localStorage.setItem("trips",JSON.stringify(d))}catch(e){console.error("Error saving to localStorage:",e)}}let Te=null,ne,E,S,T,x,L,y,g,h,O,oe,re,A,a={date:"",startAddress:"",endAddress:"",purpose:"",roundTrip:!1,distance:0,amount:0},P={defaultRate:3.79};async function xe(){const e=document.getElementById("drive-start").value.trim(),t=document.getElementById("drive-end").value.trim(),n=document.getElementById("drive-roundtrip").checked,o=parseFloat(document.getElementById("drive-rate").value);if(!e||!t){W("Manglende adresser","Indtast både start- og slutadresse.");return}const s=document.getElementById("calculate-btn"),r=document.getElementById("save-btn");try{s.disabled=!0,s.textContent="Beregner...";let u=(await Te.calculateDistance(e,t)).distance;n&&(u*=2);const c=u*o;document.getElementById("calculated-distance").textContent=u.toFixed(2),document.getElementById("calculated-amount").textContent=c.toFixed(2),r.disabled=!1}catch(i){W("Beregningsfejl","Kunne ikke beregne distance. Kontroller adresserne og prøv igen."),console.error("Error calculating distance:",i)}finally{s.disabled=!1,s.textContent="Beregn distance"}}function W(e,t){alert(`${e}: ${t}`)}function Le(){console.log("Initializing UI module"),ne=document.getElementById("trip-form"),E=document.getElementById("date"),S=document.getElementById("start-address"),T=document.getElementById("end-address"),x=document.getElementById("purpose"),L=document.getElementById("round-trip"),y=document.getElementById("calculate-btn"),g=document.getElementById("save-btn"),h=document.getElementById("use-current-location"),O=document.getElementById("distance-result"),oe=document.getElementById("distance"),re=document.getElementById("amount"),A=document.getElementById("trips-list"),E.valueAsDate=new Date,Ne(),Oe(),Be(),_()}function Oe(){y.addEventListener("click",De),ne.addEventListener("submit",Ke),h.addEventListener("click",$e),E.addEventListener("change",f),S.addEventListener("change",f),T.addEventListener("change",f),x.addEventListener("change",f),L.addEventListener("change",f)}function Be(){autocompleteAddress(S,e=>{a.startAddress=e}),autocompleteAddress(T,e=>{a.endAddress=e})}async function De(){if(f(),!a.startAddress||!a.endAddress){alert("Både start- og slutadresse skal angives");return}try{y.textContent="Beregner...",y.disabled=!0;const e=await xe(a.startAddress,a.endAddress);a.distance=e.distance,a.amount=Me(e.distance,P.defaultRate,a.roundTrip),oe.textContent=a.distance.toFixed(1),re.textContent=a.amount.toFixed(2),O.style.display="block",g.disabled=!1}catch(e){console.error("Error calculating distance:",e),alert("Der opstod en fejl ved beregning af afstand. Prøv igen.")}finally{y.textContent="Beregn",y.disabled=!1}}async function Ke(e){if(e.preventDefault(),a.distance<=0){alert("Du skal beregne afstanden først");return}try{g.textContent="Gemmer...",g.disabled=!0;const t={date:a.date,startAddress:a.startAddress,endAddress:a.endAddress,purpose:a.purpose,roundTrip:a.roundTrip,distance:a.distance,rate:P.defaultRate,amount:a.amount},n=await saveTrip(t);Ue(),_(),alert("Kørslen er gemt")}catch(t){console.error("Error saving trip:",t),alert("Der opstod en fejl ved gemning af kørsel. Prøv igen.")}finally{g.textContent="Gem",g.disabled=!0}}async function $e(){try{h.textContent="...",h.disabled=!0;const e=await getUserLocation();S.value=e.formattedAddress,a.startAddress=e.formattedAddress}catch(e){console.error("Error getting current location:",e),alert("Der opstod en fejl ved hentning af din placering. Prøv igen.")}finally{h.textContent="📍",h.disabled=!1}}function f(){a.date=E.value,a.startAddress=S.value,a.endAddress=T.value,a.purpose=x.value,a.roundTrip=L.checked,a.distance>0&&(a.distance=0,a.amount=0,O.style.display="none",g.disabled=!0)}function Me(e,t,n){return(n?e*2:e)*t}function Ue(){E.valueAsDate=new Date,S.value="",T.value="",x.value="",L.checked=!1,O.style.display="none",a={date:E.value,startAddress:"",endAddress:"",purpose:"",roundTrip:!1,distance:0,amount:0},g.disabled=!0}async function Ne(){try{P=await getSettings()}catch(e){console.error("Error loading settings:",e)}}async function _(){try{const e=await getTrips({sort:"date"});if(A.innerHTML="",e.length===0){const t=document.createElement("p");t.className="placeholder",t.textContent="Ingen kørsler registreret endnu.",A.appendChild(t);return}e.forEach(t=>{const n=Re(t);A.appendChild(n)})}catch(e){console.error("Error loading trips:",e),A.innerHTML='<p class="placeholder">Kunne ikke indlæse kørsler.</p>'}}function Re(e){const t=document.createElement("div");t.className="trip-item",t.dataset.id=e.id;const o=new Date(e.date).toLocaleDateString("da-DK");t.innerHTML=`
    <div class="trip-header">
      <strong>${o}</strong>
      <span>${e.purpose}</span>
    </div>
    <div class="trip-details">
      <p>Fra: ${e.startAddress}</p>
      <p>Til: ${e.endAddress}</p>
      <p>
        Afstand: ${e.distance.toFixed(1)} km
        ${e.roundTrip?"(tur/retur)":""}
      </p>
      <p>Beløb: ${e.amount.toFixed(2)} kr.</p>
    </div>
    <div class="trip-actions">
      <button class="edit-trip-btn" data-id="${e.id}">Rediger</button>
      <button class="delete-trip-btn" data-id="${e.id}">Slet</button>
    </div>
    ${e.synced?"":'<div class="sync-status">Ikke synkroniseret</div>'}
  `;const s=t.querySelector(".edit-trip-btn"),r=t.querySelector(".delete-trip-btn");return s.addEventListener("click",()=>Fe(e.id)),r.addEventListener("click",()=>Ge(e.id)),t}function Fe(e){alert("Redigering af kørsler kommer i fremtidige versioner")}async function Ge(e){if(confirm("Er du sikker på, at du vil slette denne kørsel?"))try{await deleteTrip(e),_()}catch(t){console.error("Error deleting trip:",t),alert("Der opstod en fejl ved sletning af kørslen. Prøv igen.")}}async function Pe(){console.log("Initializing Kørselsregistrering app...");try{const e=await se();console.log("Auth initialized, checking status");const t=await le();console.log("Auth status checked, user is authenticated:",t),window.addEventListener("userAuthenticated",n=>{console.log("Authentication event received, user authenticated:",n.detail),X()}),window.addEventListener("userSignedOut",()=>{console.log("User signed out event received")}),t&&X()}catch(e){console.error("Error initializing application:",e)}}function X(){console.log("Initializing rest of app components"),ge(),we(),Le()}document.addEventListener("DOMContentLoaded",Pe);
