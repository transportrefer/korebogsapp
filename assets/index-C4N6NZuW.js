(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const O={clientId:"129709058864-dmk39lre4jrop8ch05t1taeggmchhoqs.apps.googleusercontent.com",scopes:["https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/spreadsheets"]};console.log("Auth configuration:",{clientId:O.clientId,hasApiKey:!0,origin:window.location.origin,pathname:window.location.pathname});let v=!1,u=null,D=null,k,_,P,N,R,F,H,W;async function re(){console.log("Initializing auth module"),k=document.getElementById("login-btn"),_=document.getElementById("login-main-btn"),P=document.getElementById("logout-btn"),N=document.getElementById("auth-section"),R=document.getElementById("app-section"),F=document.getElementById("user-profile"),H=document.getElementById("user-avatar"),W=document.getElementById("user-name"),k.addEventListener("click",x),_.addEventListener("click",x),P.addEventListener("click",V),await se();const e=localStorage.getItem("auth_code");if(e){console.log("Auth code found in storage"),localStorage.removeItem("auth_code");try{await ae(e)}catch(t){console.error("Error handling callback:",t)}}return{isAuthenticated:()=>v,getCurrentUser:()=>u,login:x,logout:V}}function se(){return new Promise((e,t)=>{if(console.log("Loading Google Identity Services"),window.google&&window.google.accounts){console.log("Google Identity Services already loaded"),z(),e();return}const n=document.createElement("script");n.src="https://accounts.google.com/gsi/client",n.async=!0,n.defer=!0,n.onload=()=>{console.log("Google Identity Services script loaded"),z(),e()},n.onerror=o=>{console.error("Error loading Google Identity Services script:",o),t(o)},document.body.appendChild(n)})}function z(){console.log("Initializing Google Identity Services"),D=google.accounts.oauth2.initTokenClient({client_id:O.clientId,scope:O.scopes.join(" "),callback:e=>{if(e.error!==void 0){console.error("Token error:",e);return}console.log("Token received:",e),X(e.access_token).then(t=>{u=t,v=!0,Y()}).catch(t=>{console.error("Error fetching user profile:",t)})}})}async function X(e){const t=await fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error(`Failed to fetch user profile: ${t.status}`);return await t.json()}async function x(){if(console.log("Login clicked"),!D){console.error("Token client not initialized");return}D.requestAccessToken({prompt:"consent"})}async function ae(e){console.log("Handling OAuth callback with code");try{const t=await ie(e);t.access_token&&(u=await X(t.access_token),v=!0,Y())}catch(t){throw console.error("Error handling callback:",t),t}}async function ie(e){return console.log("Simulating code exchange for token"),{access_token:"simulated_access_token",expires_in:3600,token_type:"Bearer"}}async function V(){var e,t;console.log("Logout clicked"),(e=google==null?void 0:google.accounts)!=null&&e.oauth2?google.accounts.oauth2.revoke(((t=google.accounts.oauth2.getAccessToken())==null?void 0:t.access_token)||"",()=>{console.log("Token revoked"),v=!1,u=null,J()}):(v=!1,u=null,J())}function Y(){k.style.display="none",F.style.display="flex",H.src=u.picture||"https://ui-avatars.com/api/?name="+encodeURIComponent(u.name),W.textContent=u.name,N.style.display="none",R.style.display="block",window.dispatchEvent(new CustomEvent("userAuthenticated",{detail:u}))}function J(){k.style.display="block",F.style.display="none",N.style.display="flex",R.style.display="none",window.dispatchEvent(new CustomEvent("userSignedOut"))}async function de(){return v}const le={apiKey:"AIzaSyApeC-_5XObrNatcG_yxUna853dpkyHmlM"};let p=!1,ce=null,K=null,$=null;async function ue(){console.log("Initializing maps module");try{return await ge(),console.log("Google Maps API loaded successfully"),window.google&&window.google.maps&&(K=new google.maps.DistanceMatrixService,$=new google.maps.Geocoder,ce=new google.maps.places.AutocompleteService,p=!0),{calculateDistance:pe,getUserLocation:me,autocompleteAddress:fe,isLoaded:()=>p}}catch(e){return console.error("Error initializing Google Maps:",e),{calculateDistance:M,getUserLocation:Z,autocompleteAddress:Q,isLoaded:()=>!1}}}function ge(){return new Promise((e,t)=>{if(window.google&&window.google.maps){p=!0,e();return}const n=document.createElement("script");n.src=`https://maps.googleapis.com/maps/api/js?key=${le.apiKey}&libraries=places`,n.async=!0,n.defer=!0,n.onload=()=>{p=!0,e()},n.onerror=o=>{console.error("Google Maps API failed to load:",o),t(o)},document.head.appendChild(n)})}async function pe(e,t){if(console.log(`Calculating distance from "${e}" to "${t}"`),!p||!K)return M(e,t);try{const n=await new Promise((o,s)=>{K.getDistanceMatrix({origins:[e],destinations:[t],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC},(r,i)=>{i==="OK"?o(r):s(new Error(`Distance Matrix request failed with status: ${i}`))})});if(n.rows[0].elements[0].status==="OK"){const o=n.rows[0].elements[0];return{distance:o.distance.value/1e3,duration:Math.round(o.duration.value/60),distanceText:o.distance.text,durationText:o.duration.text,status:"OK"}}else throw new Error(`Route calculation failed with status: ${n.rows[0].elements[0].status}`)}catch(n){return console.error("Error calculating distance:",n),M(e,t)}}async function me(){console.log("Getting user location");try{const e=await new Promise((s,r)=>{if(!navigator.geolocation){r(new Error("Geolocation is not supported by your browser"));return}navigator.geolocation.getCurrentPosition(s,r,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}),{latitude:t,longitude:n}=e.coords;if(!p||!$)return{coords:{latitude:t,longitude:n},formattedAddress:`${t.toFixed(6)}, ${n.toFixed(6)}`};const o=await new Promise((s,r)=>{$.geocode({location:{lat:t,lng:n}},(i,c)=>{c==="OK"&&i[0]?s(i):r(new Error(`Geocoding failed with status: ${c}`))})});return{coords:{latitude:t,longitude:n},formattedAddress:o[0].formatted_address}}catch(e){return console.error("Error getting user location:",e),Z()}}function fe(e,t){if(console.log("Setting up address autocomplete"),!p||!window.google||!window.google.maps)return Q(e,t);const n=new google.maps.places.Autocomplete(e,{types:["address"],componentRestrictions:{country:"dk"}});n.addListener("place_changed",()=>{const o=n.getPlace();o&&o.formatted_address&&t&&t(o.formatted_address)})}function M(e,t){console.log(`Using mock distance calculation from "${e}" to "${t}"`);const n=(Math.random()*90+10).toFixed(1),o=Math.round(n*1.2);return{distance:parseFloat(n),duration:o,distanceText:`${n} km`,durationText:`${o} min`,status:"OK"}}function Z(){return console.log("Using mock user location"),{coords:{latitude:55.676098,longitude:12.568337},formattedAddress:"R친dhuspladsen 1, 1550 K칮benhavn"}}function Q(e,t){console.log("Using mock address autocomplete");const n=["R친dhuspladsen 1, 1550 K칮benhavn","Tivoli, Vesterbrogade 3, 1630 K칮benhavn","N칮rreport Station, K칮benhavn","Kongens Nytorv, K칮benhavn","Amagertorv 1, 1160 K칮benhavn","Trianglen, 2100 K칮benhavn 칒","Fisketorvet, Kalvebod Brygge 59, 1560 K칮benhavn"];e.addEventListener("input",()=>{const o=document.getElementById("mock-dropdown");if(o&&o.remove(),e.value.length>0){const s=n.filter(r=>r.toLowerCase().includes(e.value.toLowerCase()));if(s.length>0){const r=document.createElement("div");r.id="mock-dropdown",r.style.position="absolute",r.style.width=`${e.offsetWidth}px`,r.style.maxHeight="200px",r.style.overflowY="auto",r.style.background="white",r.style.border="1px solid #ddd",r.style.borderTop="none",r.style.zIndex="1000",s.forEach(c=>{const l=document.createElement("div");l.textContent=c,l.style.padding="8px 12px",l.style.cursor="pointer",l.addEventListener("mouseover",()=>{l.style.backgroundColor="#f2f2f2"}),l.addEventListener("mouseout",()=>{l.style.backgroundColor="white"}),l.addEventListener("click",()=>{e.value=c,r.remove(),t&&t(c)}),r.appendChild(l)});const i=e.getBoundingClientRect();r.style.top=`${i.bottom}px`,r.style.left=`${i.left}px`,document.body.appendChild(r)}}}),document.addEventListener("click",o=>{if(o.target!==e){const s=document.getElementById("mock-dropdown");s&&s.remove()}})}const m={localStorageKeys:{drivesData:"k칮rebogsApp_k칮rselsData",frequentAddresses:"k칮rebogsApp_oftebes칮gteAdresser",settings:"k칮rebogsApp_indstillinger"},defaultSettings:{standardSats:3.79,standardStartAdresse:"",googleSheetsId:"",visAdvarselVed60DagesReglen:!0}};let L=[],B=[],j=null;const ye=3.79;let d=[];function he(){try{const e=localStorage.getItem(m.localStorageKeys.drivesData);L=e?JSON.parse(e):[];const t=localStorage.getItem(m.localStorageKeys.frequentAddresses);B=t?JSON.parse(t):[];const n=localStorage.getItem(m.localStorageKeys.settings);j=n?{...m.defaultSettings,...JSON.parse(n)}:{...m.defaultSettings},console.log("Loaded data from localStorage:",{drives:L.length,addresses:B.length})}catch(e){console.error("Error loading data from localStorage:",e),L=[],B=[],j={...m.defaultSettings}}}function ve(){return console.log("Initializing storage module (MOCK VERSION)"),he(),{saveTrip:we,getTrips:Ie,deleteTrip:Se,updateTrip:Ee,getFavoriteAddresses:Ae,saveSettings:ke,getSettings:ee,syncToCloud:be}}async function we(e){console.log("Saving trip (MOCK VERSION):",e);const t="trip-"+Date.now(),n={...e,id:t,synced:!1,createdAt:new Date().toISOString()};return d.push(n),w(),await new Promise(o=>setTimeout(o,500)),n.synced=!0,w(),n}async function Ie(e={}){console.log("Getting trips (MOCK VERSION):",e);let t=[...d];if(e.sort&&t.sort((n,o)=>e.sort==="date"?new Date(o.date)-new Date(n.date):0),e.filter&&e.filter.date){const n=new Date(e.filter.date);t=t.filter(o=>new Date(o.date).toDateString()===n.toDateString())}return t}async function Se(e){console.log("Deleting trip (MOCK VERSION):",e);const t=d.findIndex(n=>n.id===e);return t!==-1?(d.splice(t,1),w(),!0):!1}async function Ee(e,t){console.log("Updating trip (MOCK VERSION):",e,t);const n=d.findIndex(o=>o.id===e);if(n!==-1)return d[n]={...d[n],...t,synced:!1,updatedAt:new Date().toISOString()},w(),await new Promise(o=>setTimeout(o,500)),d[n].synced=!0,w(),d[n];throw new Error("Trip not found")}async function Ae(){console.log("Getting favorite addresses (MOCK VERSION)");const e=localStorage.getItem("favoriteAddresses");if(e)return JSON.parse(e);const t=[{id:"addr-1",address:"R친dhuspladsen 1, 1550 K칮benhavn",description:"K칮benhavns R친dhus",lastUsed:new Date().toISOString()},{id:"addr-2",address:"Tivoli, Vesterbrogade 3, 1630 K칮benhavn",description:"Tivoli",lastUsed:"2023-01-15T12:30:00.000Z"}];return localStorage.setItem("favoriteAddresses",JSON.stringify(t)),t}async function ke(e){console.log("Saving settings (MOCK VERSION):",e);const n={...await ee(),...e};return localStorage.setItem("userSettings",JSON.stringify(n)),n}async function ee(){console.log("Getting settings (MOCK VERSION)");const e=localStorage.getItem("userSettings");if(e)return JSON.parse(e);const t={defaultRate:ye,defaultStartAddress:"",showRoundTripOption:!0,sheetsId:""};return localStorage.setItem("userSettings",JSON.stringify(t)),t}async function be(){console.log("Syncing to cloud (MOCK VERSION)");const e=d.filter(t=>!t.synced);return await new Promise(t=>setTimeout(t,1e3)),e.forEach(t=>{const n=d.findIndex(o=>o.id===t.id);n!==-1&&(d[n].synced=!0)}),w(),{success:!0,syncedCount:e.length,total:d.length}}function w(){try{localStorage.setItem("trips",JSON.stringify(d))}catch(e){console.error("Error saving to localStorage:",e)}}let Ce=null,te,I,S,A,b,C,y,g,h,T,ne,oe,E,a={date:"",startAddress:"",endAddress:"",purpose:"",roundTrip:!1,distance:0,amount:0},G={defaultRate:3.79};async function Te(){const e=document.getElementById("drive-start").value.trim(),t=document.getElementById("drive-end").value.trim(),n=document.getElementById("drive-roundtrip").checked,o=parseFloat(document.getElementById("drive-rate").value);if(!e||!t){q("Manglende adresser","Indtast b친de start- og slutadresse.");return}const s=document.getElementById("calculate-btn"),r=document.getElementById("save-btn");try{s.disabled=!0,s.textContent="Beregner...";let c=(await Ce.calculateDistance(e,t)).distance;n&&(c*=2);const l=c*o;document.getElementById("calculated-distance").textContent=c.toFixed(2),document.getElementById("calculated-amount").textContent=l.toFixed(2),r.disabled=!1}catch(i){q("Beregningsfejl","Kunne ikke beregne distance. Kontroller adresserne og pr칮v igen."),console.error("Error calculating distance:",i)}finally{s.disabled=!1,s.textContent="Beregn distance"}}function q(e,t){alert(`${e}: ${t}`)}function xe(){console.log("Initializing UI module"),te=document.getElementById("trip-form"),I=document.getElementById("date"),S=document.getElementById("start-address"),A=document.getElementById("end-address"),b=document.getElementById("purpose"),C=document.getElementById("round-trip"),y=document.getElementById("calculate-btn"),g=document.getElementById("save-btn"),h=document.getElementById("use-current-location"),T=document.getElementById("distance-result"),ne=document.getElementById("distance"),oe=document.getElementById("amount"),E=document.getElementById("trips-list"),I.valueAsDate=new Date,Ne(),Le(),Be(),U()}function Le(){y.addEventListener("click",Oe),te.addEventListener("submit",De),h.addEventListener("click",Ke),I.addEventListener("change",f),S.addEventListener("change",f),A.addEventListener("change",f),b.addEventListener("change",f),C.addEventListener("change",f)}function Be(){autocompleteAddress(S,e=>{a.startAddress=e}),autocompleteAddress(A,e=>{a.endAddress=e})}async function Oe(){if(f(),!a.startAddress||!a.endAddress){alert("B친de start- og slutadresse skal angives");return}try{y.textContent="Beregner...",y.disabled=!0;const e=await Te(a.startAddress,a.endAddress);a.distance=e.distance,a.amount=$e(e.distance,G.defaultRate,a.roundTrip),ne.textContent=a.distance.toFixed(1),oe.textContent=a.amount.toFixed(2),T.style.display="block",g.disabled=!1}catch(e){console.error("Error calculating distance:",e),alert("Der opstod en fejl ved beregning af afstand. Pr칮v igen.")}finally{y.textContent="Beregn",y.disabled=!1}}async function De(e){if(e.preventDefault(),a.distance<=0){alert("Du skal beregne afstanden f칮rst");return}try{g.textContent="Gemmer...",g.disabled=!0;const t={date:a.date,startAddress:a.startAddress,endAddress:a.endAddress,purpose:a.purpose,roundTrip:a.roundTrip,distance:a.distance,rate:G.defaultRate,amount:a.amount},n=await saveTrip(t);Me(),U(),alert("K칮rslen er gemt")}catch(t){console.error("Error saving trip:",t),alert("Der opstod en fejl ved gemning af k칮rsel. Pr칮v igen.")}finally{g.textContent="Gem",g.disabled=!0}}async function Ke(){try{h.textContent="...",h.disabled=!0;const e=await getUserLocation();S.value=e.formattedAddress,a.startAddress=e.formattedAddress}catch(e){console.error("Error getting current location:",e),alert("Der opstod en fejl ved hentning af din placering. Pr칮v igen.")}finally{h.textContent="游늸",h.disabled=!1}}function f(){a.date=I.value,a.startAddress=S.value,a.endAddress=A.value,a.purpose=b.value,a.roundTrip=C.checked,a.distance>0&&(a.distance=0,a.amount=0,T.style.display="none",g.disabled=!0)}function $e(e,t,n){return(n?e*2:e)*t}function Me(){I.valueAsDate=new Date,S.value="",A.value="",b.value="",C.checked=!1,T.style.display="none",a={date:I.value,startAddress:"",endAddress:"",purpose:"",roundTrip:!1,distance:0,amount:0},g.disabled=!0}async function Ne(){try{G=await getSettings()}catch(e){console.error("Error loading settings:",e)}}async function U(){try{const e=await getTrips({sort:"date"});if(E.innerHTML="",e.length===0){const t=document.createElement("p");t.className="placeholder",t.textContent="Ingen k칮rsler registreret endnu.",E.appendChild(t);return}e.forEach(t=>{const n=Re(t);E.appendChild(n)})}catch(e){console.error("Error loading trips:",e),E.innerHTML='<p class="placeholder">Kunne ikke indl칝se k칮rsler.</p>'}}function Re(e){const t=document.createElement("div");t.className="trip-item",t.dataset.id=e.id;const o=new Date(e.date).toLocaleDateString("da-DK");t.innerHTML=`
    <div class="trip-header">
      <strong>${o}</strong>
      <span>${e.purpose}</span>
    </div>
    <div class="trip-details">
      <p>Fra: ${e.startAddress}</p>
      <p>Til: ${e.endAddress}</p>
      <p>
        Afstand: ${e.distance.toFixed(1)} km
        ${e.roundTrip?"(tur/retur)":""}
      </p>
      <p>Bel칮b: ${e.amount.toFixed(2)} kr.</p>
    </div>
    <div class="trip-actions">
      <button class="edit-trip-btn" data-id="${e.id}">Rediger</button>
      <button class="delete-trip-btn" data-id="${e.id}">Slet</button>
    </div>
    ${e.synced?"":'<div class="sync-status">Ikke synkroniseret</div>'}
  `;const s=t.querySelector(".edit-trip-btn"),r=t.querySelector(".delete-trip-btn");return s.addEventListener("click",()=>Fe(e.id)),r.addEventListener("click",()=>Ge(e.id)),t}function Fe(e){alert("Redigering af k칮rsler kommer i fremtidige versioner")}async function Ge(e){if(confirm("Er du sikker p친, at du vil slette denne k칮rsel?"))try{await deleteTrip(e),U()}catch(t){console.error("Error deleting trip:",t),alert("Der opstod en fejl ved sletning af k칮rslen. Pr칮v igen.")}}async function Ue(){console.log("Initializing K칮rselsregistrering app..."),re().then(()=>de()).then(e=>{e?(console.log("User is authenticated, initializing app modules"),ue(),ve(),xe()):console.log("User is not authenticated, showing login page")}).catch(e=>{console.error("Error initializing application:",e)})}document.addEventListener("DOMContentLoaded",Ue);
